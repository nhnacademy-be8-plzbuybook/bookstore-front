<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ë°˜í’ˆ ëª©ë¡</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/layout/layout.css">

    <style>
        /* ì „ì²´ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        .main-layout {
            display: flex;
            min-height: 100vh; /* ì „ì²´ í™”ë©´ ë†’ì´ */
            flex-direction: row;
            justify-content: space-between;
        }

        header {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header .menu a, header .icons a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
        }

        header .menu a:hover, header .icons a:hover {
            color: #ddd;
        }

        .sidebar {
            width: 250px;
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
        }

        .content {
            flex: 1;
            padding: 20px;
            background-color: #fff;
        }

        footer {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            text-align: center;
            position: relative;
            bottom: 0;
            width: 100%;
        }

        footer a {
            color: #00aaff;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<header>
    <a href="/" class="logo">ğŸ“š ì±…ì‚¬ì¡°ì‰ ğŸ“š</a>
    <nav class="menu">
        <a href="/">í™ˆ</a>
        <a href="#">êµ­ë‚´ë„ì„œ</a>
        <a href="#">ì™¸êµ­ë„ì„œ</a>
        <a href="#">ì¶”ì²œë„ì„œ</a>
    </nav>
    <div class="icons">
        <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
</header>

<main class="main-layout">
    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
        <th:block th:replace="~{admin/sidebar.html}"></th:block>
    </aside>

    <!-- ì½˜í…ì¸  -->
    <section class="content">
        <div class="container mt-4">
            <h1>ì£¼ë¬¸ ë°˜í’ˆ ëª©ë¡</h1>
            <div class="d-flex mb-3">
                <input type="text" id="searchTrackingNumber" class="form-control" placeholder="ë°˜ì†¡ì¥ë²ˆí˜¸ë¡œ ê²€ìƒ‰">
                <button id="searchButton" class="btn btn-primary ms-2">ê²€ìƒ‰</button>
            </div>
            <div class="mb-3">
                <!-- í•„í„° ë²„íŠ¼ -->
                <button id="filterAll" class="btn btn-link">ì „ì²´</button>
                <button id="filterReturnRequested" class="btn btn-link">ë°˜í’ˆìš”ì²­</button>
                <button id="filterReturnCompleted" class="btn btn-link">ë°˜í’ˆì™„ë£Œ</button>
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ë°˜í’ˆìš”ì²­ ì¼ì‹œ</th>
                    <th>ë°˜í’ˆìš”ì²­ ì™„ë£Œì¼ì‹œ</th>
                    <th>ë°˜ì†¡ì¥ ë²ˆí˜¸</th>
                    <th>ìƒì„¸</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="orderProductReturn: ${orderProductReturns}">
                    <td th:text="${orderProductReturn.getId()}"></td>
                    <td th:text="${#temporals.format(orderProductReturn.getRequestedAt(), 'yyyy/MM/dd HH:mm')}"></td>
                    <td th:if="${orderProductReturn.getCompletedAt() != null}" th:text="${#temporals.format(orderProductReturn.getCompletedAt(), 'yyyy/MM/dd HH:mm')}"></td>
                    <td th:if="${orderProductReturn.getCompletedAt() == null}"></td>
                    <td th:text="${orderProductReturn.getTrackingNumber()}"></td>
                    <td>
                        <button class="btn btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#detailModal"
                                th:attr="data-id=${orderProductReturn.getId()},
                                          data-requested-at=${#temporals.format(orderProductReturn.getRequestedAt(), 'yyyy/MM/dd HH:mm')},
                                          data-requested-at=${#temporals.format(orderProductReturn.getCompletedAt(), 'yyyy/MM/dd HH:mm')},
                                          data-tracking-number=${orderProductReturn.getTrackingNumber()},
                                          data-reason=${orderProductReturn.getReason()},
                                          data-order-id=${orderProductReturn.getOrderId()},
                                          data-order-product-id=${orderProductReturn.getOrderProductId()}">
                            ë³´ê¸°
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="pagination">
                <a th:if="${currentPage > 0}" th:href="@{/admin/order-returns(page = ${currentPage} - 1)}">ì´ì „</a>
                <span>í˜„ì¬ í˜ì´ì§€: <span th:text="${currentPage + 1}"></span> / <span th:text="${totalPages}"></span></span>
                <a th:if="${currentPage < totalPages - 1}" th:href="@{/admin/order-returns(page = ${currentPage} + 1)}">ë‹¤ìŒ</a>
            </div>
        </div>
    </section>
</main>

<th:block th:replace="layout/layout::footerLayout"></th:block>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    const updateQueryStringParameter = (key, value) => {
        const url = new URL(window.location.href);
        if (value) {
            url.searchParams.set(key, value); // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ì¶”ê°€ ë˜ëŠ” ì—…ë°ì´íŠ¸
        } else {
            url.searchParams.delete(key); // ê°’ì´ ì—†ìœ¼ë©´ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ì œê±°
        }
        window.location.href = url.toString();
    };

    // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
    document.getElementById('filterAll').addEventListener('click', () => {
        updateQueryStringParameter('status', null); // ì „ì²´ ë³´ê¸°: 'status' ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ì œê±°
    });

    document.getElementById('filterReturnRequested').addEventListener('click', () => {
        updateQueryStringParameter('status', 'RETURN_REQUESTED');
    });

    document.getElementById('filterReturnCompleted').addEventListener('click', () => {
        updateQueryStringParameter('status', 'RETURN_COMPLETED');
    });

    document.getElementById('searchButton').addEventListener('click', () => {
        const trackingNumber = document.getElementById('searchTrackingNumber').value.trim();
        updateQueryStringParameter('trackingNumber', trackingNumber);
    });

    // ëª¨ë‹¬ ê´€ë ¨ ë¡œì§
    const detailModal = document.getElementById('detailModal');
    detailModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const trackingNumber = button.getAttribute('data-tracking-number');
        const requestedAt = button.getAttribute('data-requested-at');
        const completedAt = button.getAttribute('data-Completed-at');
        const reason = button.getAttribute('data-reason');
        const orderId = button.getAttribute('data-order-id');
        const orderProductId = button.getAttribute('data-order-product-id');
        document.getElementById('modalTrackingNumber').textContent = trackingNumber;
        document.getElementById('modalRequestedAt').textContent = requestedAt;
        document.getElementById('modalCompletedAt').textContent = completedAt != null ? completedAt : ' ';
        document.getElementById("modalReason").textContent = reason;

        document.getElementById('orderDetailBtn').addEventListener('click', () => {
            window.location.replace(`/admin/orders/${orderId}`);
        });

        document.getElementById('orderReturnCompleteBtn').addEventListener('click', async () => {
            const response = await fetch(`/api/orders/${orderId}/order-products/${orderProductId}/return/complete`, {
                method: "POST"
            });
            if (!response.ok) {
                alert("ì£¼ë¬¸ë°˜í’ˆìš”ì²­ ì™„ë£Œì²˜ë¦¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }
            alert('ì£¼ë¬¸ë°˜í’ˆìš”ì²­ ì™„ë£Œì²˜ë¦¬ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.reload();
        });
    });
    const currentPath = window.location.pathname;
    const sidebarLinks = document.querySelectorAll('.sidebar .group');

    sidebarLinks.forEach(link => {
        const linkPath = link.getAttribute('href');
        if (linkPath === currentPath) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }

        link.addEventListener('click', () => {
            sidebarLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
        });
    });
</script>
</body>
</html>
